{
  "name": "pl_data_ingestion",
  "properties": {
    "description": "Data ingestion pipeline for copying data from various sources to Bronze layer",
    "activities": [
      {
        "name": "CopyCustomerData",
        "type": "Copy",
        "dependsOn": [],
        "policy": {
          "timeout": "0.12:00:00",
          "retry": 3,
          "retryIntervalInSeconds": 30,
          "secureOutput": false,
          "secureInput": false
        },
        "userProperties": [],
        "typeProperties": {
          "source": {
            "type": "DelimitedTextSource",
            "storeSettings": {
              "type": "AzureBlobFSReadSettings",
              "recursive": true,
              "wildcardFileName": "*.csv",
              "enablePartitionDiscovery": false
            },
            "formatSettings": {
              "type": "DelimitedTextReadSettings",
              "skipLineCount": 0
            }
          },
          "sink": {
            "type": "ParquetSink",
            "storeSettings": {
              "type": "AzureBlobFSWriteSettings"
            },
            "formatSettings": {
              "type": "ParquetWriteSettings"
            }
          },
          "enableStaging": false,
          "translator": {
            "type": "TabularTranslator",
            "typeConversion": true,
            "typeConversionSettings": {
              "allowDataTruncation": true,
              "treatBooleanAsNumber": false
            }
          }
        },
        "inputs": [
          {
            "referenceName": "ds_source_customer_csv",
            "type": "DatasetReference"
          }
        ],
        "outputs": [
          {
            "referenceName": "ds_bronze_customer_parquet",
            "type": "DatasetReference"
          }
        ]
      },
      {
        "name": "CopyProductData",
        "type": "Copy",
        "dependsOn": [],
        "policy": {
          "timeout": "0.12:00:00",
          "retry": 3,
          "retryIntervalInSeconds": 30,
          "secureOutput": false,
          "secureInput": false
        },
        "userProperties": [],
        "typeProperties": {
          "source": {
            "type": "JsonSource",
            "storeSettings": {
              "type": "AzureBlobFSReadSettings",
              "recursive": true,
              "wildcardFileName": "*.json",
              "enablePartitionDiscovery": false
            },
            "formatSettings": {
              "type": "JsonReadSettings"
            }
          },
          "sink": {
            "type": "ParquetSink",
            "storeSettings": {
              "type": "AzureBlobFSWriteSettings"
            },
            "formatSettings": {
              "type": "ParquetWriteSettings"
            }
          },
          "enableStaging": false
        },
        "inputs": [
          {
            "referenceName": "ds_source_product_json",
            "type": "DatasetReference"
          }
        ],
        "outputs": [
          {
            "referenceName": "ds_bronze_product_parquet",
            "type": "DatasetReference"
          }
        ]
      },
      {
        "name": "CopySalesData",
        "type": "Copy",
        "dependsOn": [],
        "policy": {
          "timeout": "0.12:00:00",
          "retry": 3,
          "retryIntervalInSeconds": 30,
          "secureOutput": false,
          "secureInput": false
        },
        "userProperties": [],
        "typeProperties": {
          "source": {
            "type": "AzureSqlSource",
            "sqlReaderQuery": {
              "value": "SELECT * FROM Sales WHERE OrderDate >= '@{formatDateTime(addDays(utcNow(), -1), 'yyyy-MM-dd')}'",
              "type": "Expression"
            },
            "queryTimeout": "02:00:00",
            "partitionOption": "None"
          },
          "sink": {
            "type": "ParquetSink",
            "storeSettings": {
              "type": "AzureBlobFSWriteSettings"
            },
            "formatSettings": {
              "type": "ParquetWriteSettings"
            }
          },
          "enableStaging": false
        },
        "inputs": [
          {
            "referenceName": "ds_source_sales_sqldb",
            "type": "DatasetReference"
          }
        ],
        "outputs": [
          {
            "referenceName": "ds_bronze_sales_parquet",
            "type": "DatasetReference"
          }
        ]
      },
      {
        "name": "RunIngestionNotebook",
        "type": "SynapseNotebook",
        "dependsOn": [
          {
            "activity": "CopyCustomerData",
            "dependencyConditions": ["Succeeded"]
          },
          {
            "activity": "CopyProductData",
            "dependencyConditions": ["Succeeded"]
          },
          {
            "activity": "CopySalesData",
            "dependencyConditions": ["Succeeded"]
          }
        ],
        "policy": {
          "timeout": "0.12:00:00",
          "retry": 1,
          "retryIntervalInSeconds": 30,
          "secureOutput": false,
          "secureInput": false
        },
        "userProperties": [],
        "typeProperties": {
          "notebook": {
            "referenceName": "01_data_ingestion",
            "type": "NotebookReference"
          },
          "sparkPool": {
            "referenceName": "sparkpool",
            "type": "BigDataPoolReference"
          },
          "executorSize": "Small",
          "driverSize": "Small"
        }
      }
    ],
    "parameters": {
      "SourcePath": {
        "type": "string"
      },
      "ProcessDate": {
        "type": "string",
        "defaultValue": "@formatDateTime(utcNow(), 'yyyy-MM-dd')"
      }
    },
    "folder": {
      "name": "ETL"
    }
  }
}
